@model IEnumerable<TourTravel.Models.Blog>

@{
    ViewData["Title"] = "Blogs";
    Layout = "~/Admin/Views/Shared/_Layout-common.cshtml";
}

<!-- ‚úÖ Include Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<div class="container mt-4">
    <div class="d-flex justify-content-between mb-3">
        <h3>Blogs</h3>
        <div>
            <input type="text" id="searchBlog" class="form-control d-inline-block"
                   placeholder="Search by Title or Author"
                   value="@ViewBag.Search"
                   style="width: 220px;" />
            <button class="btn btn-primary" id="btnSearchBlog">Search</button>
            <button class="btn btn-success" id="btnAddBlog">Add Blog</button>
        </div>
    </div>

    <table class="table table-bordered table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>Title</th>
                <th>Author</th>
                <th>Image</th>
                <th style="width: 120px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                foreach (var item in Model)
                {
                    <tr>
                        <td>@item.Title</td>
                        <td>@item.Author</td>
                        <td>
                            @if (!string.IsNullOrEmpty(item.ImageUrl))
                            {
                                <img src="@item.ImageUrl" alt="Image" style="width:100px;height:60px;object-fit:cover;" />
                            }
                            else
                            {
                                <span class="text-muted">No image</span>
                            }
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-primary me-1 btnEditBlog" data-id="@item.Id" title="Edit">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>

                            <form asp-action="Delete" asp-route-id="@item.Id" method="post" class="d-inline deleteForm">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="4" class="text-center text-muted">No blogs found.</td>
                </tr>
            }
        </tbody>
    </table>

    <!-- ‚úÖ Pagination -->
    @if (ViewBag.TotalPages > 1)
    {
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <li class="page-item @(ViewBag.Page <= 1 ? "disabled" : "")">
                    <a class="page-link"
                       href="@Url.Action("Index", new { search = ViewBag.Search, page = ViewBag.Page - 1 })">Previous</a>
                </li>

                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                {
                    <li class="page-item @(ViewBag.Page == i ? "active" : "")">
                        <a class="page-link"
                           href="@Url.Action("Index", new { search = ViewBag.Search, page = i })">@i</a>
                    </li>
                }

                <li class="page-item @(ViewBag.Page >= ViewBag.TotalPages ? "disabled" : "")">
                    <a class="page-link"
                       href="@Url.Action("Index", new { search = ViewBag.Search, page = ViewBag.Page + 1 })">Next</a>
                </li>
            </ul>
        </nav>
    }
</div>

<!-- ‚úÖ Toast Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="toastContainer"></div>
</div>

<!-- ‚úÖ Modal for Create/Edit -->
<div class="modal fade" id="blogModal" tabindex="-1" aria-labelledby="blogModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-white">
                <h5 class="modal-title" id="blogModalLabel">Add Blog</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="blogForm" enctype="multipart/form-data" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="blogId" name="Id" />

                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input id="Title" name="Title" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Author</label>
                        <input id="Author" name="Author" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Content</label>
                        <textarea id="Content" name="Content" class="form-control" rows="4" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Upload Image</label>
                        <input type="file" id="imageUrl" name="imageUrl" class="form-control" accept="image/*" />
                        <div id="previewContainer" class="mt-2"></div>
                    </div>

                    <button type="submit" class="btn btn-primary">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(function () {

            // ‚úÖ Toast Function
            // ‚úÖ Toast Function (Top Slide)
            function showToast(message, type = 'bg-primary') {
                const toastId = 'toast' + Date.now();

                const toastHtml = `
                                        <div class="position-fixed top-0 end-0 p-3" style="z-index: 1050;">
                                         <div id="toastContainer">
                        <div id="${toastId}" class="toast align-items-center text-white ${type} border-0 mb-2 slide-down" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="d-flex">
                                <div class="toast-body">
                                    ${message}
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        </div>
                                </div>
                                </div>
                    `;

                $('#toastContainer').prepend(toastHtml); // prepend to show newest on top
                const toastEl = document.getElementById(toastId);

                const bsToast = new bootstrap.Toast(toastEl, { delay: 3000 });
                bsToast.show();

                toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
            }


            // üîç Search
            $('#btnSearchBlog').click(function () {
                const search = $('#searchBlog').val();
                window.location.href = '@Url.Action("Index", "Blogs")' + '?search=' + encodeURIComponent(search);
            });

            $('#searchBlog').keypress(function (e) {
                if (e.which === 13) $('#btnSearchBlog').click();
            });

            // ‚ûï Add Blog
            $('#btnAddBlog').click(function () {
                $('#blogModalLabel').text('Add Blog');
                $('#blogForm')[0].reset();
                $('#blogId').val('');
                $('#previewContainer').empty();
                $('#blogModal').modal('show');
            });

            // ‚úèÔ∏è Edit Blog
            $('.btnEditBlog').click(function () {
                const id = $(this).data('id');
                $.get('@Url.Action("GetBlogById", "Blogs")', { id: id }, function (data) {
                    if (data) {
                        $('#blogModalLabel').text('Edit Blog');
                        $('#blogId').val(data.id);
                        $('#Title').val(data.title);
                        $('#Author').val(data.author);
                        $('#Content').val(data.content);
                        $('#previewContainer').html(data.imageUrl ? `<img src="${data.imageUrl}" style="width:150px;height:100px;object-fit:cover;" />` : '');
                        $('#blogModal').modal('show');
                    }
                });
            });

            // üñºÔ∏è Image Preview
            $('#imageUrl').on('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        $('#previewContainer').html(`<img src="${e.target.result}" style="width:150px;height:100px;object-fit:cover;" />`);
                    };
                    reader.readAsDataURL(file);
                }
            });

            // üíæ Submit Blog (AJAX)
            $('#blogForm').submit(function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                const id = $('#blogId').val();
                const url = id ? '@Url.Action("Edit", "Blogs")' : '@Url.Action("Create", "Blogs")';

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (res) {
                        if (res.success) {
                            $('#blogModal').modal('hide');
                            showToast(res.message, 'bg-success');
                            location.reload();
                        } else {
                            showToast(res.message, 'bg-danger');
                        }
                    },
                    error: function () {
                        showToast('Something went wrong while saving the blog.', 'bg-danger');
                    }
                });
            });

            // üóëÔ∏è Delete Blog (AJAX)
            $('.deleteForm').submit(function (e) {
                e.preventDefault();
                if (!confirm('Are you sure you want to delete this blog?')) return;

                const form = $(this);
                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: form.serialize(),
                    success: function (res) {
                        showToast('Blog deleted successfully', 'bg-success');
                        location.reload();
                    },
                    error: function () {
                        showToast('Failed to delete blog', 'bg-danger');
                    }
                });
            });

        });
    </script>
}
