@await Component.InvokeAsync("HeroSection")

<div class="tour-area py-120">
    <div class="container">
        <div class="row">
            <!-- LEFT SIDEBAR -->
            <div class="col-lg-4">
                <div class="tour-sidebar">

                    <!-- Search Form -->
                    <div class="search-area">
                        <div class="search-form-wrapper">
                            <h4>Search Tours</h4>
                            <form id="searchForm" method="get">
                                <div class="row align-items-end">

                                    <!-- Destination -->
                                    <div class="col-12 search-input">
                                        <div class="form-group">
                                            <label>Destination</label>
                                            @await Component.InvokeAsync("DestinationDropdown")
                                        </div>
                                    </div>

                                    <!-- Check-In -->
                                    <div class="col-12 search-input">
                                        <div class="form-group">
                                            <label>Check In</label>
                                            <input type="date" id="checkInDate" name="checkInDate" class="form-control"
                                                   value="@Context.Request.Query["checkInDate"]" />
                                        </div>
                                    </div>

                                    <!-- Check-Out -->
                                    <div class="col-12 search-input">
                                        <div class="form-group">
                                            <label>Check Out</label>
                                            <input type="date" id="checkOutDate" name="checkOutDate" class="form-control"
                                                   value="@Context.Request.Query["checkOutDate"]" />
                                        </div>
                                    </div>

                                    <!-- Submit -->
                                    <div class="col-12 mt-10">
                                        <button type="submit" class="search-btn">
                                            <i class="far fa-search"></i> Find Now
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- PRICE RANGE -->
                    <div class="tour-widget mt-4">
                        <h4>Price Range</h4>
                        <div>
                            <input id="priceRange" type="range" min="500" max="50000" step="500" value="500" class="w-100" />
                            <div class="mt-2">
                                <span>Selected: </span>
                                <strong id="priceValue">500</strong> / 50000
                            </div>
                        </div>
                    </div>

                    <!-- DURATION -->
                    <div class="tour-widget mt-4">
                        <h4>Durations</h4>
                        <ul>
                            <li><input type="checkbox" class="durationFilter" data-min="0" data-max="1" /> 0–1 days</li>
                            <li><input type="checkbox" class="durationFilter" data-min="1" data-max="3" /> 1–3 days</li>
                            <li><input type="checkbox" class="durationFilter" data-min="3" data-max="6" /> 3–6 days</li>
                            <li><input type="checkbox" class="durationFilter" data-min="6" data-max="9" /> 6–9 days</li>
                            <li><input type="checkbox" class="durationFilter" data-min="9" data-max="10" /> 9–10 days</li>
                        </ul>
                    </div>


                </div>
            </div>

            @{
                int? destinationIdParsed = null;
                if (int.TryParse(Context.Request.Query["DestinationId"], out int tempDest))
                {
                    destinationIdParsed = tempDest;
                }

                string checkInDate = Context.Request.Query["checkInDate"].ToString();
                string checkOutDate = Context.Request.Query["checkOutDate"].ToString();

            }

            <!-- TOUR CARDS -->
            <div class="col-lg-8">
                <div id="tourCardContainer">
                    @await Component.InvokeAsync("TourCards", new
                        {
                            ShowHeading = false,
                            take = 8,
                            columnClass = "col-md-6 col-lg-6",
                            DestinationId = destinationIdParsed,
                            checkInDate = checkInDate,
                            checkOutDate = checkOutDate,
                            maxPerson = (int?)null,
                            minPrice = 500,
                            maxPrice = (decimal?)null,
                            minDuration = (int?)null,
                            maxDuration = (int?)null
                        })
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    $(document).ready(function () {

        // $("#priceRange").on("input", function () {
        //     $("#priceValue").text($(this).val());
        //     refreshTourList();
        // });
        document.getElementById("priceRange").addEventListener("input", function () {

            let price = this.value;

            // Read existing filter values
            let dest = document.getElementById("DestinationId").value;
            let cin = document.getElementById("checkInDate").value;
            let cout = document.getElementById("checkOutDate").value;

            // Build new URL exactly like "Find Now"
            let newUrl = `/Tours?DestinationId=${dest}&checkInDate=${cin}&checkOutDate=${cout}&minPrice=500&maxPrice=${price}`;

            // FULL PAGE RELOAD
            window.location.href = newUrl;
        });

        // $(".durationFilter").on("change", function () {
        //     refreshTourList();
        // });
        // $(".durationFilter").on("change", function () {
        //     $(".durationFilter").not(this).prop("checked", false);
        //     refreshTourList();
        // });
        $(".durationFilter").on("change", function () {
            $(".durationFilter").not(this).prop("checked", false);
            let selected = $(".durationFilter:checked");
            let minD = selected.length ? selected.data("min") : "";
            let maxD = selected.length ? selected.data("max") : "";
            let dest = $("#DestinationId").val();
            let cin = $("#checkInDate").val();
            let cout = $("#checkOutDate").val();
            let price = $("#priceRange").val();
            let newUrl = `/Tours?DestinationId=${dest}&checkInDate=${cin}&checkOutDate=${cout}&minPrice=500&maxPrice=${price}&minDuration=${minD}&maxDuration=${maxD}`;
            window.location.href = newUrl;
        });


        $("#searchForm").on("submit", function (e) {
            let dest = $("#DestinationId").val();
            let cin = $("#checkInDate").val();
            let cout = $("#checkOutDate").val();

            if (!dest) return showError(e, "Please select destination!");
            if (!cin) return showError(e, "Select Check-In date!");
            if (!cout) return showError(e, "Select Check-Out date!");
            if (cout <= cin) return showError(e, "Check-Out must be later!");


            let today = new Date().toISOString().split("T")[0];


            if (cin < today) {
                e.preventDefault();
                showToast("Check-In date cannot be before today!", "error");
                return false;
            }


            if (cout <= checkIn) {
                e.preventDefault();
                showToast("Check-Out must be later than Check-In!", "error");
                return false;
            }

            return true;
        });

        function showError(e, msg) {
            e.preventDefault();
            showToast(msg, "error");
        }


        function refreshTourList() {
            let dest = $("#DestinationId").val();
            let cin = $("#checkInDate").val();
            let cout = $("#checkOutDate").val();
            let price = $("#priceRange").val();

            // ---- SINGLE SELECT DURATION ----
            let selected = $(".durationFilter:checked");
            let minD = selected.length ? selected.data("min") : null;
            let maxD = selected.length ? selected.data("max") : null;

            // let minD = null, maxD = null;

            // $(".durationFilter:checked").each(function () {
            //     let mn = $(this).data("min");
            //     let mx = $(this).data("max");

            //     if (minD === null || mn < minD) minD = mn;
            //     if (maxD === null || mx > maxD) maxD = mx;
            // });

            // $("#tourCardContainer").load("/Tours/LoadTours", {
            //     DestinationId: dest,
            //     checkInDate: cin,
            //     checkOutDate: cout,
            //     minPrice: 500,
            //     maxPrice: price,
            //     minDuration: minD,
            //     maxDuration: maxD
            // });
        }
    });
</script>
