@model TourTravel.Models.TourGuideView

@{
    ViewData["Title"] = "Add Tour Guide";
    Layout = "~/Admin/Views/Shared/_Layout-common.cshtml";
}

<div class="container mt-4">
    <div class="card shadow border-0">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fa-solid fa-user-tie me-2"></i>Add Tour Guide</h5>
            <a href="@Url.Action("Index", "TourGuide")" class="btn btn-light btn-sm">
                <i class="fa-solid fa-arrow-left"></i> Back
            </a>
        </div>

        <div class="card-body">
            <form id="tourGuideForm" enctype="multipart/form-data" method="post" asp-action="Create" novalidate>
                @Html.AntiForgeryToken()

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Name <span class="text-danger">*</span></label>
                        <input asp-for="Name" class="form-control" id="Name" required />
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Role <span class="text-danger">*</span></label>
                        <input asp-for="Role" class="form-control" id="Role" required />
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Email <span class="text-danger">*</span></label>
                        <input asp-for="Email" class="form-control" id="Email" type="email" required />
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Phone <span class="text-danger">*</span></label>
                        <input asp-for="Phone" class="form-control" id="Phone" required />
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Facebook</label>
                        <input asp-for="Facebook" class="form-control" id="Facebook" />
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Twitter</label>
                        <input asp-for="Twitter" class="form-control" id="Twitter" />
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Instagram</label>
                        <input asp-for="Instagram" class="form-control" id="Instagram" />
                    </div>

                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">LinkedIn</label>
                        <input asp-for="LinkedIn" class="form-control" id="LinkedIn" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">YouTube</label>
                        <input asp-for="YouTube" class="form-control" id="YouTube" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Upload Profile Image (800*600)<span class="text-danger">*</span></label>
                        <input type="file" name="ImageFile" id="ImageFile" class="form-control" accept="image/*" />
                    </div>

                    <div id="previewContainer" class="mb-3 text-center"></div>

                    <div class="col-md-12 mb-3">
                        <label class="form-label fw-semibold">Introduction<span class="text-danger">*</span></label>
                        <textarea asp-for="Introduction" id="Introduction" class="form-control"></textarea>
                    </div>
                    q`s
                    <div class="col-md-12 mb-3">
                        <label class="form-label fw-semibold">Biography<span class="text-danger">*</span></label>
                        <textarea asp-for="Biography" id="Biography" class="form-control"></textarea>
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-3">
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" id="clearBtn" class="btn btn-secondary">Clear</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast container -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 99999;">
    <div id="toastContainer"></div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>

    <script>
        let introEditor, bioEditor;

        ClassicEditor.create(document.querySelector('#Introduction'))
            .then(editor => introEditor = editor)
            .catch(console.error);

        ClassicEditor.create(document.querySelector('#Biography'))
            .then(editor => bioEditor = editor)
            .catch(console.error);

        //  Image preview
        $('#ImageFile').on('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    $('#previewContainer').html(
                        `<img src="${event.target.result}" class="img-thumbnail shadow-sm" style="max-width:150px; border-radius:10px;" />`
                    );
                };
                reader.readAsDataURL(file);
            } else {
                $('#previewContainer').empty();
            }
        });

        //  Clear form
        $('#clearBtn').click(() => {
            $('#tourGuideForm')[0].reset();
            $('#previewContainer').empty();
            if (introEditor) introEditor.setData('');
            if (bioEditor) bioEditor.setData('');
            showToast('Form cleared successfully.', 'bg-info');
        });

        //  Validation regex patterns
        const emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
        const phoneRegex = /^(\+?\d{1,3}[- ]?)?\d{10,15}$/;


        //  Submit form with image validation (like Blog)
        $('#tourGuideForm').submit(function (e) {
            e.preventDefault();

            const name = $('#Name').val().trim();
            const role = $('#Role').val().trim();
            const email = $('#Email').val().trim();
            const phone = $('#Phone').val().trim();
              const intro = introEditor ? introEditor.getData().trim() : '';
            const bio = bioEditor ? bioEditor.getData().trim() : '';
            if (!name || !role || !email || !phone|| !intro || !bio) {
                showToast('Please fill all required fields.', 'bg-danger');
                return;
            }

            //  Empty field check
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address (e.g., name@example.com).', 'bg-danger');
                return;
            }

            if (!phoneRegex.test(phone)) {
                showToast('Please enter a valid phone number with 10â€“15 digits.', 'bg-danger');
                return;
            }
            //  Phone validation
            if (!phoneRegex.test(phone)) {
                showToast('Please enter a valid phone number.', 'bg-danger');
                return;
            }

            const file = $('#ImageFile')[0].files[0];
            if (!file) {
                showToast('Profile image is required.', 'bg-danger');
                return;
            }



            const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg'];
            const maxSize = 5 * 1024 * 1024; // 5MB

            if (!allowedTypes.includes(file.type)) {
                showToast('Only JPG or PNG images are allowed.', 'bg-danger');
                return;
            }

            if (file.size > maxSize) {
                showToast('Image size must be less than 5MB.', 'bg-danger');
                return;
            }

            //  Check image dimensions like Blog (minimum 800x800)
            const img = new Image();
            img.src = URL.createObjectURL(file);
            img.onload = function () {
               if (img.width !== 800 || img.height !== 600) {
                        showToast('Image dimensions must be 800x600.', 'bg-danger');
                        return;
                    }

                //  Proceed only after image dimension validation passes
                const intro = introEditor ? introEditor.getData().trim() : '';
                const bio = bioEditor ? bioEditor.getData().trim() : '';

                const formData = new FormData($('#tourGuideForm')[0]);
                formData.set('Introduction', intro);
                formData.set('Biography', bio);

                $.ajax({
                    url: '/admin/TourGuide/Create',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (res) {
                        if (res.success) {
                            showToast(res.message, 'bg-success');
                            setTimeout(() => window.location.href = '/admin/TourGuide', 3000);
                        } else {
                            showToast(res.message || 'Validation failed.', 'bg-danger');
                        }
                    },
                    error: function () {
                        showToast('An error occurred while saving.', 'bg-danger');
                    }
                });
            };
        });
    </script>
}

