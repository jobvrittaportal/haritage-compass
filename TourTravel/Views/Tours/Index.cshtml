
@await Component.InvokeAsync("HeroSection")

@{
    // Parse query params or set defaults
    int? destinationIdParsed = null;
    if (int.TryParse(Context.Request.Query["DestinationId"], out int tempDest))
    {
        destinationIdParsed = tempDest;
    }

    string checkInDate = Context.Request.Query["checkInDate"].ToString() ?? "";
    string checkOutDate = Context.Request.Query["checkOutDate"].ToString() ?? "";

    int minPriceQuery = 50;
    int maxPriceQuery = 50000;

    if (int.TryParse(Context.Request.Query["minPrice"], out int minP))
    {
        minPriceQuery = minP;
    }
    if (int.TryParse(Context.Request.Query["maxPrice"], out int maxP))
    {
        maxPriceQuery = maxP;
    }
    int? MaxPerson = null;
    if (int.TryParse(Context.Request.Query["maxPerson"], out int MaxPersona))
    {
        MaxPerson = MaxPersona;
    }

}

<div class="tour-area py-120">
    <div class="container">
        <div class="row">
            <!-- LEFT SIDEBAR -->
            <div class="col-lg-4">
                <div class="tour-sidebar">

                    <!-- Search Form -->
                    <div class="search-area">
                        <div class="search-form-wrapper">
                            <h4>Search Tours</h4>
                            <form id="searchForm" method="get" onsubmit="return validateForm()">

                                <div class="row align-items-end">

                                    <!-- Destination -->
                                    <div class="col-12 search-input">
                                        <div class="form-group">
                                            <label>Destination</label>
                                            @* Your existing dropdown component *@
                                            @await Component.InvokeAsync("DestinationDropdown", new { SelectedDestinationId = destinationIdParsed })
                                            @* IMPORTANT: Your DestinationDropdown must support preselecting by SelectedDestinationId param *@
                                        </div>
                                    </div>

                                    <!-- Check-In -->
                                    <div class="col-12 search-input">
                                        <div class="form-group">
                                            <label>Check In</label>
                                            <input type="date" id="checkInDate" name="checkInDate" class="form-control"
                                                   value="@checkInDate"  />
                                        </div>
                                    </div>

                                    <!-- Check-Out -->
                                    <div class="col-12 search-input">
                                        <div class="form-group">
                                            <label>Check Out</label>
                                            <input type="date" id="checkOutDate" name="checkOutDate" class="form-control"
                                                   value="@checkOutDate"  />
                                        </div>
                                    </div>
                                    <!-- Person -->

                                    <div class="col-12 search-input">
                                        <div class="form-group">
                                            <label>Person</label>
                                            <input type="number" id="maxPerson" name="maxPerson" min="1" class="form-control text-center" value="@MaxPerson">

                                        </div>
                                    </div>


                                    <!-- Price Range -->
                                    <div class="tour-widget mt-4">
                                        <h4>Price Range</h4>
                                        <div class="price-range-box">
                                            <div class="price-range-input mb-2">
                                                <input type="text" readonly id="price-amount" class="form-control" />
                                            </div>
                                            <div class="price-range"></div>
                                        </div>
                                    </div>

                                    <!-- Hidden price inputs -->
                                    <input type="hidden" id="minPrice" name="minPrice" value="@minPriceQuery" />
                                    <input type="hidden" id="maxPrice" name="maxPrice" value="@maxPriceQuery" />

                                    <!-- Submit -->
                                    <div class="col-12 mt-10">
                                        <button type="submit" class="search-btn">
                                            <i class="far fa-search"></i> Find Now
                                        </button>
                                    </div>

                                </div>

                            </form>
                        </div>
                    </div>

                </div>
            </div>

            <!-- TOUR CARDS -->
            <div class="col-lg-8">
                <div id="tourCardContainer">
                    @await Component.InvokeAsync("TourCards", new
                        {
                            ShowHeading = false,
                            take = 8,
                            columnClass = "col-md-6 col-lg-6",
                            DestinationId = destinationIdParsed,
                            checkInDate = checkInDate,
                            checkOutDate = checkOutDate,
                            maxPerson = MaxPerson,
                            minPrice = minPriceQuery,
                            maxPrice = maxPriceQuery,
                            minDuration = (int?)null,
                            maxDuration = (int?)null
                        })
                </div>
            </div>

        </div>
    </div>
</div>
@section Scripts {
    <script>
      function validateForm() {
    // Destination validation (always required)
    var dest = $("select[name='DestinationId']").val();
    if (!dest || dest === "0" || dest === "") {
        showToast("Please select a destination.", "error");
        return false;
    }

    // Check-In and Check-Out values
    var checkInVal = $("#checkInDate").val();
    var checkOutVal = $("#checkOutDate").val();

    // If either Check-In or Check-Out is filled, validate dates
    if (checkInVal || checkOutVal) {
        var today = new Date();
        today.setHours(0,0,0,0); // normalize to midnight for comparison

        if (checkInVal) {
            var checkInDate = new Date(checkInVal);
            if (checkInDate < today) {
                showToast("Check-In date cannot be in the past.", "error");
                return false;
            }
        } else {
            // Check-In empty but Check-Out filled → require check-in
            showToast("Please select Check-In date if Check-Out is selected.", "error");
            return false;
        }

        if (checkOutVal) {
            var checkOutDate = new Date(checkOutVal);
            if (checkInVal) {
                var checkInDate = new Date(checkInVal);
                if (checkOutDate < checkInDate) {
                    showToast("Check-Out date must be equal or after Check-In date.", "error");
                    return false;
                }
            }
        } else {
            // Check-Out empty but Check-In filled → require check-out
            showToast("Please select Check-Out date if Check-In is selected.", "error");
            return false;
        }
    }

    return true; // All validations passed
}


        $(function () {
            // Use Razor variables to set slider initial values
            let minPrice = @minPriceQuery;
            let maxPrice = @maxPriceQuery;

            $(".price-range").slider({
                range: true,
                min: 50,
                max: 50000,
                values: [minPrice, maxPrice],
                slide: function (event, ui) {
                    $("#price-amount").val("₹" + ui.values[0] + " - ₹" + ui.values[1]);
                    $("#minPrice").val(ui.values[0]);
                    $("#maxPrice").val(ui.values[1]);
                }
            });

            // Initialize price display and hidden inputs on page load
            $("#price-amount").val("₹" + $(".price-range").slider("values", 0) + " - ₹" + $(".price-range").slider("values", 1));
            $("#minPrice").val($(".price-range").slider("values", 0));
            $("#maxPrice").val($(".price-range").slider("values", 1));
        });
    </script>
}
