@model TourTravel.Models.TicketResponse

@{
    ViewData["Title"] = "Support Tickets";
    Layout = "~/Admin/Views/Shared/_Layout-common.cshtml";
}

<div class="container mt-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Support Tickets</h4>

        <div class="d-flex align-items-center">

            <!-- Search -->
            <form method="get" asp-action="Index" class="me-2">
                <div class="input-group" style="width: 200px;">
                    <input type="text" name="filter" value="@ViewBag.Filter" class="form-control" placeholder="Search..." />
                    <button class="btn btn-outline-secondary">
                        <i class="fa fa-search"></i>
                    </button>
                </div>
            </form>

            <!-- Create Button -->
            <a href="/admin/Support/Create" class="btn btn-primary ms-2">
                <i class="fa fa-plus"></i> New
            </a>
        </div>
    </div>

    <!-- Error handling -->
    @if (ViewBag.ErrorMessage != null)
    {
        <div class="alert alert-danger">@ViewBag.ErrorMessage</div>
    }
    else if (Model == null || Model.result == null || !Model.result.Any())
    {
        <div class="alert alert-info text-center">No tickets found.</div>
    }
    else
    {
        <!-- Table -->
        <table class="table table-striped table-bordered align-middle">
            <thead>
                <tr>
                    <th>Ticket No.</th>
                    <th>Ticket ID</th>
                    <th>Subject</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Open Date</th>
                    <th>Raised By</th>
                    <th>Agent</th>
                    <th >Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in Model.result)
                {
                    <tr id="ticketRow_@t.ticket_Number">
                        <td>@t.ticket_Number</td>
                        <td>@t.ticket_Id</td>
                        <td>@Html.Raw(t.subject)</td>
                        <td>@t.priority</td>
                        <td>@t.status_Name</td>
                        <td>@t.open</td>
                        <td>@t.raised_By_Name</td>
                        <td>@t.agent_Name</td>
                        <td class="text-center" style="white-space:nowrap; width: 180px;">

                            <!-- View File (only if file exists) -->
                            @if (!string.IsNullOrEmpty(t.file))
                            {
                                <button class="btn btn-sm btn-outline-primary mx-1 view-file"
                                        data-file="@t.file"
                                        title="View File">
                                    <i class="fa fa-file"></i>
                                </button>
                            }


                            <!-- Edit Ticket -->
                            <button class="btn btn-sm btn-outline-success mx-1 edit-ticket-btn"
                                    data-id="@t.ticket_Number"
                                    title="Edit Ticket">
                                <i class="fa fa-edit"></i>
                            </button>

                            <!-- View History -->
                            <button class="btn btn-sm btn-outline-info mx-1 view-history"
                                    data-id="@t.ticket_Number"
                                    title="View History">
                                <i class="fa fa-eye"></i>
                            </button>

                            <!-- Add Activity -->
                            <button class="btn btn-sm btn-outline-primary mx-1 view-activity"
                                    data-id="@t.ticket_Number"
                                    title="Add Activity">
                                <i class="fa fa-tasks"></i>
                            </button>

                        </td>


                    </tr>
                }
            </tbody>
        </table>

        <!-- PAGINATION -->
        <nav>
            <ul class="pagination justify-content-center mt-3">
                @{
                    int totalPages = ViewBag.TotalPages ?? 1;
                    int currentPage = ViewBag.Page ?? 1;
                    string filter = ViewBag.Filter ?? "";
                }

                @for (int i = 1; i <= totalPages; i++)
                {
                    <li class="page-item @(i == currentPage ? "active" : "")">
                        <a class="page-link" href="?page=@i&filter=@filter">@i</a>
                    </li>
                }
            </ul>
        </nav>
    }
</div>

<!-- HISTORY MODAL -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="historyModalLabel">Ticket History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body" id="historyBody">
                <div class="text-center">Loading...</div>
            </div>

        </div>
    </div>
</div>


<div class="modal fade" id="fileModal" tabindex="-1" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Ticket File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body text-center">
                <img id="popupImage" src="" style="max-width: 100%; border-radius: 6px;" />
            </div>

        </div>
    </div>
</div>



<!-- EDIT TICKET MODAL -->
<div class="modal fade" id="editTicketModal" tabindex="-1" aria-labelledby="editTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="editTicketModalLabel">Edit Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">

                <form id="editTicketForm">
                    <input type="hidden" id="edit_Ticket_Id" />

                    <div class="row">

                        <!-- Application Group -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Application Group <span class="text-danger">*</span></label>
                            <select id="edit_Application_Id" class="form-select" required>
                                <option value="">-- Select Application --</option>
                            </select>
                        </div>

                        <!-- Assign Group -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Assign Group <span class="text-danger">*</span></label>
                            <select id="edit_Assign_Group_Id" class="form-select" required>
                                <option value="">-- Select Assign Group --</option>
                            </select>
                        </div>

                        <!-- Priority -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Priority <span class="text-danger">*</span></label>
                            <select id="edit_Priority" class="form-select" required>
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>

                        <!-- Impact -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Impact <span class="text-danger">*</span></label>
                            <select id="edit_Impact" class="form-select" required>
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>

                        <!-- Subject -->
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Subject <span class="text-danger">*</span></label>
                            <input type="text" id="edit_Subject" class="form-control" required />
                        </div>

                        <!-- Description -->
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Description <span class="text-danger">*</span></label>
                            <textarea id="edit_Desc" class="form-control" rows="4" required></textarea>
                        </div>

                        <!-- STATUS - OPTIONAL -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status (Optional)</label>
                            <select id="editsupportStatus" class="form-select" data-current-status-id="1">
                                <option value="">-- Select Status --</option>
                            </select>
                        </div>

                        <!-- REMARK - OPTIONAL -->
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Remark (Optional)</label>
                            <input type="text" id="edit_Remark" class="form-control" />
                        </div>

                        <!-- Update Status Button -->
                        <div class="col-md-12 mb-3">
                            <button type="button" id="btnUpdateTicketStatus" class="btn btn-success">
                                Update Status
                            </button>
                        </div>

                    </div>

                    <!-- Footer Buttons -->
                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button type="submit" id="updateBtn" class="btn btn-success d-flex align-items-center gap-2">
                            <span id="updateText">Update</span>
                            <div id="updateLoader" class="spinner-border spinner-border-sm text-light" style="display:none;"></div>
                        </button>

                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>

                </form>

            </div>

        </div>
    </div>
</div>


<div class="modal fade" id="noteFileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Attachment Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body text-center" id="noteFileBody">
                <!-- Content loads dynamically -->
            </div>

        </div>
    </div>
</div>




<!-- ACTIVITY / NOTES MODAL -->
<div class="modal fade" id="activityModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Activities</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <!-- Add New Note -->
                <form id="noteForm" enctype="multipart/form-data">
                    <input type="hidden" id="note_ticketId" name="Ticket_Id" />

                    <label class="fw-bold">Work Activities <span class="text-danger">*</span></label>
                    <textarea class="form-control" name="Note_Text" id="note_text" rows="3"></textarea>

                    <div class="mt-3">
                        <label class="fw-bold">Attachment</label><br />
                        <input type="file" name="Attachment" id="note_file" />
                    </div>

                    <button type="button" id="postNoteBtn" class="btn btn-primary mt-3">
                        Post
                    </button>
                </form>

                <hr />

                <!-- Notes List -->
                <h6 class="fw-bold">Comments:</h6>
                <div id="notesContainer">
                    <div class="text-center">Loading...</div>
                </div>

            </div>

        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="position-fixed top-0 end-0 p-3" style="z-index:99999;">
    <div id="toastContainer"></div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

    <script>

        //
        // ⭐ GLOBAL TOAST FUNCTION
        //
        function showToast(message, type) {
            const toastId = 'toast' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${type} border-0 show" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            document.getElementById("toastContainer").insertAdjacentHTML('beforeend', toastHtml);
            setTimeout(() => document.getElementById(toastId)?.remove(), 3000);
        }



        //
        // ⭐ VIEW HISTORY
        //
        $(document).on("click", ".view-history", function () {

            let ticketId = $(this).data("id");

            $("#historyBody").html(`<div class="text-center">Loading...</div>`);

            fetch(`/admin/Support/getTicketHistory?ticket_Id=${ticketId}`)
                .then(res => res.json())
                .then(data => {
                    if (!data || data.length === 0) {
                        $("#historyBody").html(`<div class="text-center text-danger">No history found</div>`);
                        return;
                    }

                    let html = "";

                    data.forEach(entry => {

                        html += `
                            <div class="mb-3 border rounded p-3">
                                <strong>Updated By:</strong> ${entry.updatedBy} <br />
                                <strong>Updated At:</strong> ${entry.updatedAt} <br />

                                ${entry.file_Url ? `
                                    <button class="btn btn-sm btn-outline-primary mt-2 view-note-file"
                                        data-file="/admin/Support/NoteFile/${entry.file_Url}">
                                        <i class="fa fa-eye"></i>
                                    </button>` : ""}

                                <table class="table table-sm table-bordered mt-2 mb-0">
                                    <thead>
                                        <tr>
                                            <th>Field</th>
                                            <th>Old Value</th>
                                            <th>New Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;

                        entry.changes.forEach(change => {

                            let newValueHtml = "";

                            if (change.field === "Attachment" && change.newValue) {
                                newValueHtml = `
                                    <button class="btn btn-sm btn-outline-primary view-note-file"
                                        data-file="/admin/Support/NoteFile/${change.newValue}">
                                        <i class="fa fa-eye"></i>
                                    </button>`;
                            } else {
                                newValueHtml = change.newValue || "-";
                            }

                            html += `
                                <tr>
                                    <td>${change.field}</td>
                                    <td>${change.oldValue || '-'}</td>
                                    <td>${newValueHtml}</td>
                                </tr>`;
                        });

                        html += `
                                    </tbody>
                                </table>
                            </div>`;
                    });

                    $("#historyBody").html(html);
                })
                .catch(() => {
                    $("#historyBody").html(`<div class="text-center text-danger">Error loading history</div>`);
                });

            new bootstrap.Modal(document.getElementById('historyModal')).show();
        });



        //
        // ⭐ VIEW ACTIVITY
        //
        $(document).on("click", ".view-activity", function () {

            let ticketId = $(this).data("id");

            $("#note_ticketId").val(ticketId);
            $("#note_text").val("");
            $("#note_file").val("");

            loadNotes(ticketId);

            new bootstrap.Modal(document.getElementById('activityModal')).show();
        });
        
        // ⭐ LOAD NOTES
        function loadNotes(ticketId) {

            $("#notesContainer").html(`<div class="text-center">Loading...</div>`);

            fetch(`/admin/Support/getNotes?ticket_Id=${ticketId}`)
                .then(res => res.json())
                .then(data => {
                    if (!data || data.totalCount === 0) {
                        $("#notesContainer").html(`<div class="text-center text-danger">No notes found</div>`);
                        return;
                    }

                    let html = "";

                    data.result.forEach(item => {

                        html += `
                            <div class="p-3 mb-2 bg-light rounded border">
                                <strong>${item.created_By_Name || ''}</strong>
                                <span class="float-end">${item.created_At || ''}</span>

                                <div class="mt-2">${item.note_Text || ''}</div>

                                ${item.file_Url ? `
                                    <button class="btn btn-sm btn-outline-primary mt-2 view-note-file"
                                        data-file="/admin/Support/NoteFile/${item.file_Url}">
                                        <i class="fa fa-eye"></i>
                                    </button>` : ""}
                            </div>`;
                    });

                    $("#notesContainer").html(html);
                })
                .catch(() => {
                    $("#notesContainer").html(`<div class="text-center text-danger">Error loading notes</div>`);
                });
        }

        // ⭐ POST NEW NOTE
        $("#postNoteBtn").on("click", function () {

            let formData = new FormData(document.getElementById("noteForm"));

            fetch("/admin/Support/addNote", {
                method: "POST",
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    showToast("Activity added successfully!", "bg-success");
                    loadNotes($("#note_ticketId").val());
                    $("#note_text").val("");
                    $("#note_file").val("");
                })
                .catch(() => {
                    showToast("Error adding activity", "bg-danger");
                });
        });

        // ⭐ LOAD DROPDOWNS + OPEN EDIT MODAL
        $(document).ready(function () {

            function loadEditDropdowns() {

                // Application
                fetch('/admin/Support/ApplicationGroup')
                    .then(res => res.json())
                    .then(data => {
                        let appSelect = $("#edit_Application_Id");
                        appSelect.empty().append('<option value="">-- Select Application --</option>');
                        data.forEach(x => {
                            appSelect.append(`<option value="${x.support_Application_Id}">${x.application_Name}</option>`);
                        });
                    });

                // Assign Group
                fetch('/admin/Support/AssignGroup')
                    .then(res => res.json())
                    .then(data => {
                        let assignSelect = $("#edit_Assign_Group_Id");
                        assignSelect.empty().append('<option value="">-- Select Assign Group --</option>');
                        data.forEach(x => {
                            assignSelect.append(`<option value="${x.assign_Group_Id}">${x.assign_Group_Name}</option>`);
                        });
                    });

                // Status (Only 5 & 6)
                fetch('/admin/Support/supportStatus')
                    .then(res => res.json())
                    .then(data => {
                        const filtered = data.filter(x => x.status_Id === 5 || x.status_Id === 6);

                        let statusSelect = $("#editsupportStatus");
                        statusSelect.empty().append('<option value="">-- Select Status --</option>');

                        filtered.forEach(x => {
                            statusSelect.append(`<option value="${x.status_Id}">${x.status}</option>`);
                        });
                    });
            }

            loadEditDropdowns();

            let originalTicketData = null;

            $(document).on("click", ".edit-ticket-btn", function () {

                let ticketId = $(this).data("id");

                $("#editTicketForm")[0].reset();

                fetch(`/admin/Support/getTicketDetails?ticket_Number=${ticketId}`)
                    .then(res => res.json())
                    .then(data => {

                        if (!data || !data.ticket_Id) {
                            showToast("Failed to load ticket details", "bg-danger");
                            return;
                        }

                        originalTicketData = data;

                        $("#edit_Ticket_Id").val(data.ticket_Number);
                        $("#edit_Application_Id").val(data.application_Group_Id);
                        $("#edit_Assign_Group_Id").val(data.assigned_Group_Id);
                        $("#edit_Priority").val(data.priority);
                        $("#edit_Impact").val(data.impact);
                        $("#edit_Subject").val(data.subject);
                        $("#edit_Desc").val(data.description);
                        $("#editsupportStatus").val(data.status ?? "");

                        new bootstrap.Modal(document.getElementById('editTicketModal')).show();
                    })
                    .catch(() => showToast("Error loading ticket details", "bg-danger"));
            });

            // ⭐ UPDATE TICKET WITH LOADER + TOAST
            $("#editTicketForm").on("submit", function (e) {
                e.preventDefault();

                let ticketId = $("#edit_Ticket_Id").val();
                let appId = $("#edit_Application_Id").val();
                let assignGroupId = $("#edit_Assign_Group_Id").val();
                let priority = $("#edit_Priority").val();
                let impact = $("#edit_Impact").val();
                let subject = $("#edit_Subject").val().trim();
                let desc = $("#edit_Desc").val().trim();

                if (!appId || !assignGroupId || !priority || !impact || !subject || !desc) {
                    showToast("Please fill all required fields.", "bg-danger");
                    return;
                }

                // SHOW BUTTON LOADER
                const btn = $("#updateBtn");
                const updateText = $("#updateText");
                const updateLoader = $("#updateLoader");

                btn.prop("disabled", true);
                updateText.text("Updating...");
                updateLoader.show();

                // BUILD CHANGES
                let changes = [];

                function addChange(field, oldVal, newVal) {
                    if ((oldVal ?? "") !== (newVal ?? "")) {
                        changes.push({
                            Field_Name: field,
                            Old_Value: oldVal ?? "",
                            New_Value: newVal ?? ""
                        });
                    }
                }

                addChange("Application_Id", originalTicketData.application_Group_Id, parseInt(appId));
                addChange("Assign_Group_Id", originalTicketData.assigned_Group_Id, parseInt(assignGroupId));
                addChange("Priority", originalTicketData.priority, priority);
                addChange("Impact", originalTicketData.impact, impact);
                addChange("Subject", originalTicketData.subject, subject);
                addChange("Desc", originalTicketData.description, desc);

                const updateDto = {
                    Ticket_Id: parseInt(ticketId),
                    Application_Id: parseInt(appId),
                    Assign_Group_Id: parseInt(assignGroupId),
                    Priority: priority,
                    Impact: impact,
                    Subject: subject,
                    Desc: desc,
                    Changes: changes
                };

                fetch("/admin/Support/updateTicket", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updateDto)
                })
                    .then(res => res.json())
                    .then(data => {

                        resetLoader();

                        if (data.message) {
                            showToast(data.message, "bg-success");
                            const modal = bootstrap.Modal.getInstance(document.getElementById("editTicketModal"));
                            if (modal) modal.hide();
                            setTimeout(() => location.reload(), 1200);
                        } else {
                            showToast(data.error || "Unexpected response", "bg-danger");
                        }
                    })
                    .catch(() => {
                        resetLoader();
                        showToast("Error updating ticket", "bg-danger");
                    });

                function resetLoader() {
                    btn.prop("disabled", false);
                    updateText.text("Update");
                    updateLoader.hide();
                }
            });
            // ⭐ UPDATE STATUS ONLY
            $("#btnUpdateTicketStatus").on("click", function () {

                let ticketId = $("#edit_Ticket_Id").val();
                let statusId = $("#editsupportStatus").val();
                let remark = $("#edit_Remark").val();

                if (!statusId) {
                    showToast("Please select a status", "bg-danger");
                    return;
                }

                let payload = {
                    Ticket_Id: parseInt(ticketId),
                    Status: parseInt(statusId),
                    Remark: remark
                };

                fetch("/admin/support/changeTicketStatus", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                })
                    .then(res => res.json())
                    .then(() => {
                        showToast("Status updated successfully!", "bg-success");
                        setTimeout(() => location.reload(), 1000);
                    })
                    .catch(() => showToast("Status update failed", "bg-danger"));
            });
            // ⭐ VIEW FILE / NOTE FILE PREVIEW
            $(document).on("click", ".view-note-file", function () {

                let fileUrl = $(this).data("file");
                let ext = fileUrl.split('.').pop().toLowerCase();

                let html = "";

                if (["jpg", "jpeg", "png", "gif", "bmp", "webp"].includes(ext)) {
                    html = `<img src="${fileUrl}" style="max-width:100%;border-radius:6px;" />`;
                }
                else if (ext === "pdf") {
                    html = `<iframe src="${fileUrl}" style="width:100%;height:500px;border:none;"></iframe>`;
                }
                else {
                    html = `<a href="${fileUrl}" download class="btn btn-success">Download File</a>`;
                }

                $("#noteFileBody").html(html);
                $("#noteFileModal").modal("show");
            });
        });

              $(document).on("click", ".view-file", function () {
            let fileUrl = $(this).data("file");
            $("#popupImage").attr("src", fileUrl);
            $("#fileModal").modal("show");
        });

        // ⭐ MULTIPLE MODALS FIX
        $(document).on('show.bs.modal', '.modal', function () {
            $('.modal-backdrop').not(':first').remove();

            var zIndex = 1050 + (10 * $('.modal:visible').length);
            $(this).css('z-index', zIndex);

            setTimeout(() => {
                $('.modal-backdrop')
                    .not('.stacked')
                    .css('z-index', zIndex - 1)
                    .addClass('stacked');
            }, 50);
        });
    </script>
}

